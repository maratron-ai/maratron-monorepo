#!/bin/bash

# Custom git push wrapper that automatically syncs subtrees
# Usage: ./git-push [git push arguments]

set -e

echo "ğŸš€ Enhanced git push with auto-sync..."
echo ""

# Run the actual git push with all provided arguments
echo "ğŸ“¤ Pushing to monorepo..."
git push "$@"

# Check if push was successful and we're on main branch
if [ $? -eq 0 ]; then
    current_branch=$(git branch --show-current)
    
    if [ "$current_branch" = "main" ]; then
        echo ""
        echo "ğŸ”„ Auto-syncing subtrees..."
        
        echo "ğŸ“¤ Syncing apps/web to web-origin..."
        if git subtree push --prefix=apps/web web-origin main 2>/dev/null; then
            echo "âœ… Web repository synced"
        else
            echo "âš ï¸  Force pushing web subdirectory..."
            git push web-origin `git subtree split --prefix=apps/web $current_branch`:main --force
        fi

        echo "ğŸ“¤ Syncing apps/ai to ai-origin..."
        if git subtree push --prefix=apps/ai ai-origin main 2>/dev/null; then
            echo "âœ… AI repository synced"
        else
            echo "âš ï¸  Force pushing AI subdirectory..."
            git push ai-origin `git subtree split --prefix=apps/ai $current_branch`:main --force
        fi

        echo ""
        echo "ğŸ‰ All repositories synced successfully!"
        echo ""
        echo "ğŸ“Š Summary:"
        echo "  - Monorepo: âœ… Pushed"
        echo "  - Web repo: âœ… Synced"
        echo "  - AI repo:  âœ… Synced"
    else
        echo ""
        echo "â„¹ï¸  Auto-sync skipped (not on main branch)"
    fi
else
    echo "âŒ Git push failed - skipping auto-sync"
    exit 1
fi